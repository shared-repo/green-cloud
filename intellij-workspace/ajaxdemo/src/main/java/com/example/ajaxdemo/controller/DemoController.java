package com.example.ajaxdemo.controller;

import com.example.ajaxdemo.dto.StockQuote;
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

//@Controller
@RestController // 모든 메서드에 @ResponseBody 자동 설정
@RequestMapping(path = { "/demo" })
public class DemoController {

    @RequestMapping(path = { "/key-economy-indicator" }, produces = "application/json;charset=utf-8")
    // @ResponseBody
    public String loadKeyEconomyIndicator() {

        String apiKey = "XIXDXQPRTA4PLPFTS37V";
        String respType = "json";
        String lang = "kr";
        int from = 1, to = 100;
        String code1 = "731Y001", code2 = "0000001";
        String cycle = "D";
        String fromDate = "20240813", toDate = "20240814";

        String apiUrl = String.format("https://ecos.bok.or.kr/api/StatisticSearch/%s/%s/%s/%d/%d/%s/%s/%s/%s/%s",
                                      apiKey, respType, lang, from, to, code1, cycle, fromDate,toDate, code2);
        String data = get(apiUrl, "GET", null);
        System.out.println(data);
        return data;
    }

    @RequestMapping(path = "/historical-stock-quotes", produces = "application/json;charset=utf-8")
    public String loadStockDataBySymbol(@RequestParam(defaultValue = "GOOG") String symbol) {
//        String apiKey = "IR73JL7R00PQQZUT";
//        String apiUrl = "https://api.polygon.io/v2/aggs/ticker/AAPL/range/1/day/2023-01-09/2023-01-09?apiKey=vYpAGYzqkgJTEBUYWVm351HZSZ3Xa3pq"
//        //String apiUrl = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=IBM&apikey=demo";

        String data = "{\"ticker\":\"GOOG\",\"queryCount\":157,\"resultsCount\":157,\"adjusted\":true,\"results\":[{\"v\":2.0071885e+07,\"vw\":139.1284,\"o\":139.6,\"c\":139.56,\"h\":140.6147,\"l\":137.74,\"t\":1704171600000,\"n\":228961},{\"v\":1.8974308e+07,\"vw\":140.139,\"o\":138.6,\"c\":140.36,\"h\":141.09,\"l\":138.43,\"t\":1704258000000,\"n\":191844},{\"v\":1.8253331e+07,\"vw\":138.9222,\"o\":139.85,\"c\":138.04,\"h\":140.635,\"l\":138.01,\"t\":1704344400000,\"n\":182258},{\"v\":1.5439475e+07,\"vw\":137.6653,\"o\":138.352,\"c\":137.39,\"h\":138.81,\"l\":136.85,\"t\":1704430800000,\"n\":174619},{\"v\":1.6545293e+07,\"vw\":139.7572,\"o\":138,\"c\":140.53,\"h\":140.64,\"l\":137.88,\"t\":1704690000000,\"n\":166650},{\"v\":1.9579667e+07,\"vw\":141.9562,\"o\":140.06,\"c\":142.56,\"h\":142.7998,\"l\":139.79,\"t\":1704776400000,\"n\":215290},{\"v\":1.6641881e+07,\"vw\":143.6174,\"o\":142.52,\"c\":143.8,\"h\":144.525,\"l\":142.46,\"t\":1704862800000,\"n\":191508},{\"v\":1.747113e+07,\"vw\":143.8003,\"o\":144.895,\"c\":143.67,\"h\":146.66,\"l\":142.215,\"t\":1704949200000,\"n\":221273},{\"v\":1.3998729e+07,\"vw\":144.2244,\"o\":144.34,\"c\":144.24,\"h\":144.74,\"l\":143.36,\"t\":1705035600000,\"n\":153631},{\"v\":1.9188189e+07,\"vw\":144.1233,\"o\":143.43,\"c\":144.08,\"h\":145.84,\"l\":143.0564,\"t\":1705381200000,\"n\":210681},{\"v\":1.7884548e+07,\"vw\":142.2109,\"o\":142.91,\"c\":142.89,\"h\":143.41,\"l\":140.51,\"t\":1705467600000,\"n\":214181},{\"v\":1.88768e+07,\"vw\":144.6894,\"o\":143.44,\"c\":144.99,\"h\":145.585,\"l\":143.35,\"t\":1705554000000,\"n\":214251},{\"v\":2.7181032e+07,\"vw\":147.3655,\"o\":146.305,\"c\":147.97,\"h\":148.04,\"l\":145.8,\"t\":1705640400000,\"n\":266925},{\"v\":2.1779232e+07,\"vw\":148.5338,\"o\":148.71,\"c\":147.71,\"h\":150.015,\"l\":147.58,\"t\":1705899600000,\"n\":225144},{\"v\":1.4113649e+07,\"vw\":148.3144,\"o\":147.72,\"c\":148.68,\"h\":148.86,\"l\":147.19,\"t\":1705986000000,\"n\":172869},{\"v\":1.9245031e+07,\"vw\":150.6715,\"o\":150.29,\"c\":150.35,\"h\":151.57,\"l\":149.84,\"t\":1706072400000,\"n\":228019},{\"v\":2.149512e+07,\"vw\":153.4168,\"o\":151.74,\"c\":153.64,\"h\":154.76,\"l\":151.22,\"t\":1706158800000,\"n\":282971},{\"v\":1.9494488e+07,\"vw\":153.54,\"o\":152.87,\"c\":153.79,\"h\":154.11,\"l\":152.8,\"t\":1706245200000,\"n\":224485},{\"v\":2.0909258e+07,\"vw\":154.1532,\"o\":153.64,\"c\":154.84,\"h\":155.2,\"l\":152.92,\"t\":1706504400000,\"n\":248342},{\"v\":2.6537134e+07,\"vw\":152.8671,\"o\":154.01,\"c\":153.05,\"h\":155.04,\"l\":152.775,\"t\":1706590800000,\"n\":344566},{\"v\":4.3908584e+07,\"vw\":143.2172,\"o\":145.39,\"c\":141.8,\"h\":145.59,\"l\":141.55,\"t\":1706677200000,\"n\":592280},{\"v\":2.5526855e+07,\"vw\":143.1333,\"o\":143.69,\"c\":142.71,\"h\":144.62,\"l\":142.26,\"t\":1706763600000,\"n\":329689},{\"v\":4.2106127e+07,\"vw\":141.6363,\"o\":140.89,\"c\":143.54,\"h\":143.88,\"l\":138.17,\"t\":1706850000000,\"n\":528121},{\"v\":2.9254444e+07,\"vw\":145.215,\"o\":144.04,\"c\":144.93,\"h\":146.67,\"l\":143.91,\"t\":1707109200000,\"n\":342883},{\"v\":2.1517655e+07,\"vw\":145.4096,\"o\":145.96,\"c\":145.41,\"h\":146.74,\"l\":144.52,\"t\":1707195600000,\"n\":240631},{\"v\":2.1436126e+07,\"vw\":146.397,\"o\":146.12,\"c\":146.68,\"h\":147,\"l\":145.2103,\"t\":1707282000000,\"n\":236932},{\"v\":1.8241319e+07,\"vw\":147.1074,\"o\":146.97,\"c\":147.22,\"h\":147.61,\"l\":146.42,\"t\":1707368400000,\"n\":191624},{\"v\":2.1877693e+07,\"vw\":149.7306,\"o\":147.95,\"c\":150.22,\"h\":150.695,\"l\":147.43,\"t\":1707454800000,\"n\":241601},{\"v\":1.7236108e+07,\"vw\":149.3934,\"o\":149.54,\"c\":148.73,\"h\":150.59,\"l\":148.56,\"t\":1707714000000,\"n\":206614},{\"v\":1.8138482e+07,\"vw\":146.4141,\"o\":146.07,\"c\":146.37,\"h\":148.04,\"l\":145.11,\"t\":1707800400000,\"n\":247195},{\"v\":1.6651824e+07,\"vw\":146.6373,\"o\":147.37,\"c\":147.14,\"h\":147.83,\"l\":145.555,\"t\":1707886800000,\"n\":209145},{\"v\":2.6724305e+07,\"vw\":143.4425,\"o\":144.46,\"c\":143.94,\"h\":144.76,\"l\":141.88,\"t\":1707973200000,\"n\":349244},{\"v\":2.1865118e+07,\"vw\":142.3707,\"o\":144.21,\"c\":141.76,\"h\":144.48,\"l\":141.52,\"t\":1708059600000,\"n\":271617},{\"v\":1.8625589e+07,\"vw\":142.1658,\"o\":140.94,\"c\":142.2,\"h\":143.3285,\"l\":140.8,\"t\":1708405200000,\"n\":235771},{\"v\":1.6499584e+07,\"vw\":143.2543,\"o\":142.64,\"c\":143.84,\"h\":143.98,\"l\":141.91,\"t\":1708491600000,\"n\":220920},{\"v\":2.3000707e+07,\"vw\":145.1479,\"o\":146.12,\"c\":145.32,\"h\":146.2,\"l\":144.01,\"t\":1708578000000,\"n\":249676},{\"v\":1.4519434e+07,\"vw\":145.3034,\"o\":144.97,\"c\":145.29,\"h\":145.955,\"l\":144.79,\"t\":1708664400000,\"n\":189743},{\"v\":3.3513011e+07,\"vw\":140.2236,\"o\":143.45,\"c\":138.75,\"h\":143.84,\"l\":138.74,\"t\":1708923600000,\"n\":402504},{\"v\":2.2363981e+07,\"vw\":139.5097,\"o\":139.41,\"c\":140.1,\"h\":140.49,\"l\":138.5,\"t\":1709010000000,\"n\":273360},{\"v\":3.0628702e+07,\"vw\":137.4655,\"o\":139.1,\"c\":137.43,\"h\":139.28,\"l\":136.64,\"t\":1709096400000,\"n\":334769},{\"v\":3.5485006e+07,\"vw\":139.0744,\"o\":138.35,\"c\":139.78,\"h\":139.95,\"l\":137.57,\"t\":1709182800000,\"n\":287329},{\"v\":2.8551525e+07,\"vw\":138.7688,\"o\":139.61,\"c\":138.08,\"h\":140,\"l\":137.975,\"t\":1709269200000,\"n\":314669},{\"v\":4.357151e+07,\"vw\":134.0105,\"o\":136.54,\"c\":134.2,\"h\":136.63,\"l\":132.86,\"t\":1709528400000,\"n\":495654},{\"v\":2.844755e+07,\"vw\":133.0401,\"o\":132.74,\"c\":133.78,\"h\":134.02,\"l\":131.55,\"t\":1709614800000,\"n\":343013},{\"v\":2.31752e+07,\"vw\":132.7237,\"o\":134.24,\"c\":132.56,\"h\":134.74,\"l\":131.95,\"t\":1709701200000,\"n\":302445},{\"v\":2.4107282e+07,\"vw\":134.7866,\"o\":133.89,\"c\":135.24,\"h\":135.82,\"l\":132.66,\"t\":1709787600000,\"n\":279499},{\"v\":2.649516e+07,\"vw\":137.1159,\"o\":135.035,\"c\":136.29,\"h\":138.985,\"l\":134.8,\"t\":1709874000000,\"n\":333673},{\"v\":2.2536365e+07,\"vw\":138.9942,\"o\":137.07,\"c\":138.94,\"h\":139.98,\"l\":137.07,\"t\":1710129600000,\"n\":299630},{\"v\":1.9019696e+07,\"vw\":139.611,\"o\":138.25,\"c\":139.62,\"h\":140.28,\"l\":138.21,\"t\":1710216000000,\"n\":235625},{\"v\":1.9636999e+07,\"vw\":141.1197,\"o\":140.06,\"c\":140.77,\"h\":142.19,\"l\":140.01,\"t\":1710302400000,\"n\":242700},{\"v\":3.6117913e+07,\"vw\":143.8083,\"o\":142.3,\"c\":144.34,\"h\":144.73,\"l\":141.485,\"t\":1710388800000,\"n\":410370},{\"v\":4.1039494e+07,\"vw\":142.2968,\"o\":143.41,\"c\":142.17,\"h\":144.34,\"l\":141.1301,\"t\":1710475200000,\"n\":300056},{\"v\":4.7677092e+07,\"vw\":150.2583,\"o\":149.37,\"c\":148.48,\"h\":152.93,\"l\":148.14,\"t\":1710734400000,\"n\":638465},{\"v\":1.7748367e+07,\"vw\":147.7903,\"o\":148.98,\"c\":147.92,\"h\":149.62,\"l\":147.01,\"t\":1710820800000,\"n\":218450},{\"v\":1.7720246e+07,\"vw\":148.9809,\"o\":148.79,\"c\":149.68,\"h\":149.76,\"l\":147.665,\"t\":1710907200000,\"n\":248031},{\"v\":1.9843915e+07,\"vw\":149.0813,\"o\":150.32,\"c\":148.74,\"h\":151.305,\"l\":148.0101,\"t\":1710993600000,\"n\":260573},{\"v\":1.9252925e+07,\"vw\":151.6865,\"o\":150.24,\"c\":151.77,\"h\":152.56,\"l\":150.09,\"t\":1711080000000,\"n\":243267},{\"v\":1.5114728e+07,\"vw\":150.5671,\"o\":150.95,\"c\":151.15,\"h\":151.456,\"l\":148.8,\"t\":1711339200000,\"n\":195747},{\"v\":1.9312694e+07,\"vw\":152.13,\"o\":151.24,\"c\":151.7,\"h\":153.2,\"l\":151.03,\"t\":1711425600000,\"n\":211856},{\"v\":1.6580364e+07,\"vw\":151.3525,\"o\":152.145,\"c\":151.94,\"h\":152.69,\"l\":150.13,\"t\":1711512000000,\"n\":222193},{\"v\":2.1105628e+07,\"vw\":152.1635,\"o\":152,\"c\":152.26,\"h\":152.67,\"l\":151.33,\"t\":1711598400000,\"n\":206731},{\"v\":2.4469815e+07,\"vw\":155.7895,\"o\":151.83,\"c\":156.5,\"h\":157,\"l\":151.65,\"t\":1711944000000,\"n\":301866},{\"v\":1.7598064e+07,\"vw\":155.1383,\"o\":154.75,\"c\":155.87,\"h\":155.99,\"l\":153.46,\"t\":1712030400000,\"n\":229211},{\"v\":1.7266175e+07,\"vw\":155.8758,\"o\":154.92,\"c\":156.37,\"h\":156.55,\"l\":154.1321,\"t\":1712116800000,\"n\":212996},{\"v\":2.4184842e+07,\"vw\":153.8969,\"o\":155.08,\"c\":151.94,\"h\":156.18,\"l\":151.88,\"t\":1712203200000,\"n\":339217},{\"v\":1.6297319e+07,\"vw\":153.7686,\"o\":151.68,\"c\":153.94,\"h\":154.84,\"l\":151.081,\"t\":1712289600000,\"n\":228132},{\"v\":1.664153e+07,\"vw\":155.9755,\"o\":154.015,\"c\":156.14,\"h\":156.655,\"l\":153.99,\"t\":1712548800000,\"n\":212811},{\"v\":2.153814e+07,\"vw\":158.0945,\"o\":157.35,\"c\":158.14,\"h\":159.89,\"l\":156.64,\"t\":1712635200000,\"n\":272532},{\"v\":1.6336974e+07,\"vw\":157.2433,\"o\":157.88,\"c\":157.66,\"h\":158.16,\"l\":156.2,\"t\":1712721600000,\"n\":243773},{\"v\":1.7841703e+07,\"vw\":159.8751,\"o\":158.34,\"c\":160.79,\"h\":161.1199,\"l\":157.93,\"t\":1712808000000,\"n\":243303},{\"v\":1.6989765e+07,\"vw\":159.6335,\"o\":159.405,\"c\":159.19,\"h\":161.7,\"l\":158.6,\"t\":1712894400000,\"n\":228278},{\"v\":2.0493789e+07,\"vw\":158.3748,\"o\":160.28,\"c\":156.33,\"h\":160.83,\"l\":156.15,\"t\":1713153600000,\"n\":286940},{\"v\":1.5024008e+07,\"vw\":156.1771,\"o\":155.64,\"c\":156,\"h\":157.23,\"l\":155.05,\"t\":1713240000000,\"n\":225494},{\"v\":1.522787e+07,\"vw\":157.2979,\"o\":157.19,\"c\":156.88,\"h\":158.681,\"l\":156.135,\"t\":1713326400000,\"n\":233495},{\"v\":1.3794011e+07,\"vw\":157.5469,\"o\":156.925,\"c\":157.46,\"h\":158.485,\"l\":156.21,\"t\":1713412800000,\"n\":221658},{\"v\":1.9670213e+07,\"vw\":155.8013,\"o\":157.75,\"c\":155.72,\"h\":157.99,\"l\":153.91,\"t\":1713499200000,\"n\":266199},{\"v\":1.6693975e+07,\"vw\":157.5986,\"o\":156.01,\"c\":157.95,\"h\":159.185,\"l\":155.66,\"t\":1713758400000,\"n\":228047},{\"v\":1.5874791e+07,\"vw\":159.7333,\"o\":158.59,\"c\":159.92,\"h\":160.48,\"l\":157.965,\"t\":1713844800000,\"n\":209325},{\"v\":1.8954637e+07,\"vw\":160.1056,\"o\":159.09,\"c\":161.1,\"h\":161.39,\"l\":158.82,\"t\":1713931200000,\"n\":271030},{\"v\":3.555829e+07,\"vw\":160.1915,\"o\":153.36,\"c\":157.95,\"h\":158.28,\"l\":152.768,\"t\":1714017600000,\"n\":512719},{\"v\":5.5430487e+07,\"vw\":173.7389,\"o\":175.99,\"c\":173.69,\"h\":176.42,\"l\":171.4,\"t\":1714104000000,\"n\":658827},{\"v\":3.5730361e+07,\"vw\":169.172,\"o\":170.77,\"c\":167.9,\"h\":171.38,\"l\":167.06,\"t\":1714363200000,\"n\":426988},{\"v\":2.8532636e+07,\"vw\":166.5913,\"o\":167.38,\"c\":164.64,\"h\":169.87,\"l\":164.5,\"t\":1714449600000,\"n\":310966},{\"v\":2.5051655e+07,\"vw\":166.6727,\"o\":166.18,\"c\":165.57,\"h\":168.81,\"l\":164.9,\"t\":1714536000000,\"n\":355968},{\"v\":1.6580577e+07,\"vw\":167.4833,\"o\":166.67,\"c\":168.46,\"h\":168.53,\"l\":165.69,\"t\":1714622400000,\"n\":212644},{\"v\":2.2564132e+07,\"vw\":167.6899,\"o\":169.54,\"c\":168.99,\"h\":169.85,\"l\":164.98,\"t\":1714708800000,\"n\":323137},{\"v\":1.4869552e+07,\"vw\":168.9526,\"o\":169.22,\"c\":169.83,\"h\":169.9,\"l\":167.89,\"t\":1714968000000,\"n\":216489},{\"v\":2.058996e+07,\"vw\":172.3599,\"o\":170.12,\"c\":172.98,\"h\":173.47,\"l\":170,\"t\":1715054400000,\"n\":264401},{\"v\":1.3063271e+07,\"vw\":171.3302,\"o\":170.75,\"c\":171.16,\"h\":171.9092,\"l\":170.522,\"t\":1715140800000,\"n\":166468},{\"v\":1.1821652e+07,\"vw\":170.9353,\"o\":171.15,\"c\":171.58,\"h\":172.44,\"l\":169.93,\"t\":1715227200000,\"n\":171362},{\"v\":1.8576516e+07,\"vw\":169.8459,\"o\":169.69,\"c\":170.29,\"h\":171.34,\"l\":167.91,\"t\":1715313600000,\"n\":263084},{\"v\":1.9213947e+07,\"vw\":168.4853,\"o\":165.847,\"c\":170.9,\"h\":170.95,\"l\":165.76,\"t\":1715572800000,\"n\":269325},{\"v\":1.8627813e+07,\"vw\":171.6764,\"o\":171.59,\"c\":171.93,\"h\":172.78,\"l\":170.42,\"t\":1715659200000,\"n\":229574},{\"v\":1.668778e+07,\"vw\":173.3207,\"o\":172.3,\"c\":173.88,\"h\":174.0459,\"l\":172.03,\"t\":1715745600000,\"n\":223589},{\"v\":1.7120366e+07,\"vw\":175.4309,\"o\":174.6,\"c\":175.43,\"h\":176.34,\"l\":174.05,\"t\":1715832000000,\"n\":226125},{\"v\":1.6434957e+07,\"vw\":176.8948,\"o\":175.55,\"c\":177.29,\"h\":177.495,\"l\":174.98,\"t\":1715918400000,\"n\":188308},{\"v\":1.4439313e+07,\"vw\":178.5577,\"o\":177.31,\"c\":178.46,\"h\":179.95,\"l\":177.225,\"t\":1716177600000,\"n\":193417},{\"v\":1.3725768e+07,\"vw\":179.0375,\"o\":178.4,\"c\":179.54,\"h\":179.82,\"l\":177.31,\"t\":1716264000000,\"n\":159425},{\"v\":1.5100514e+07,\"vw\":177.5845,\"o\":178.4,\"c\":178,\"h\":178.852,\"l\":176.7801,\"t\":1716350400000,\"n\":169020},{\"v\":1.4527309e+07,\"vw\":176.5303,\"o\":178.78,\"c\":175.06,\"h\":179.91,\"l\":174.54,\"t\":1716436800000,\"n\":191828},{\"v\":1.1091214e+07,\"vw\":176.5148,\"o\":176.52,\"c\":176.33,\"h\":177.3044,\"l\":175.2,\"t\":1716523200000,\"n\":148159},{\"v\":1.5055479e+07,\"vw\":177.5314,\"o\":175.74,\"c\":178.02,\"h\":178.51,\"l\":175.68,\"t\":1716868800000,\"n\":184064},{\"v\":1.4259381e+07,\"vw\":177.5547,\"o\":176.81,\"c\":177.4,\"h\":178.23,\"l\":176.26,\"t\":1716955200000,\"n\":164128},{\"v\":1.7688897e+07,\"vw\":174.4322,\"o\":176.69,\"c\":173.56,\"h\":176.69,\"l\":173.23,\"t\":1717041600000,\"n\":218838},{\"v\":2.5377188e+07,\"vw\":173.2392,\"o\":173.4,\"c\":173.96,\"h\":174.42,\"l\":170.97,\"t\":1717128000000,\"n\":250156},{\"v\":1.9083409e+07,\"vw\":173.9482,\"o\":173.88,\"c\":174.42,\"h\":175.86,\"l\":172.45,\"t\":1717387200000,\"n\":249211},{\"v\":1.2969567e+07,\"vw\":174.4507,\"o\":174.45,\"c\":175.13,\"h\":175.19,\"l\":173.22,\"t\":1717473600000,\"n\":161923},{\"v\":1.4664305e+07,\"vw\":176.6816,\"o\":176.535,\"c\":177.07,\"h\":177.97,\"l\":175.29,\"t\":1717560000000,\"n\":206153},{\"v\":1.3765229e+07,\"vw\":178.0601,\"o\":177.43,\"c\":178.35,\"h\":178.71,\"l\":177.21,\"t\":1717646400000,\"n\":195521},{\"v\":1.417593e+07,\"vw\":177.456,\"o\":178.46,\"c\":175.95,\"h\":179.42,\"l\":175.79,\"t\":1717732800000,\"n\":217014},{\"v\":1.5845601e+07,\"vw\":175.904,\"o\":176.45,\"c\":176.63,\"h\":178.47,\"l\":174.38,\"t\":1717992000000,\"n\":244850},{\"v\":1.316921e+07,\"vw\":177.2633,\"o\":177.72,\"c\":178.19,\"h\":178.39,\"l\":175.44,\"t\":1718078400000,\"n\":182405},{\"v\":1.727371e+07,\"vw\":179.4852,\"o\":179.75,\"c\":179.56,\"h\":182.08,\"l\":177.78,\"t\":1718164800000,\"n\":241238},{\"v\":1.4427875e+07,\"vw\":177.4082,\"o\":177.84,\"c\":176.74,\"h\":178.51,\"l\":176.66,\"t\":1718251200000,\"n\":178575},{\"v\":1.1398936e+07,\"vw\":177.9763,\"o\":175.852,\"c\":178.37,\"h\":178.73,\"l\":175.852,\"t\":1718337600000,\"n\":146178},{\"v\":1.4552067e+07,\"vw\":178.2075,\"o\":176.98,\"c\":178.78,\"h\":179.92,\"l\":176.49,\"t\":1718596800000,\"n\":186242},{\"v\":1.5001299e+07,\"vw\":176.7752,\"o\":178.79,\"c\":176.45,\"h\":178.91,\"l\":175.62,\"t\":1718683200000,\"n\":216722},{\"v\":1.5451971e+07,\"vw\":177.4666,\"o\":176.71,\"c\":177.71,\"h\":178.74,\"l\":176.46,\"t\":1718856000000,\"n\":203959},{\"v\":5.6986554e+07,\"vw\":180.3701,\"o\":178.49,\"c\":180.26,\"h\":182.5117,\"l\":178.06,\"t\":1718942400000,\"n\":321261},{\"v\":1.6431151e+07,\"vw\":180.9856,\"o\":181.28,\"c\":180.79,\"h\":182.08,\"l\":180.23,\"t\":1719201600000,\"n\":231096},{\"v\":1.707205e+07,\"vw\":184.0531,\"o\":181.145,\"c\":185.58,\"h\":185.75,\"l\":181.105,\"t\":1719288000000,\"n\":216770},{\"v\":1.279558e+07,\"vw\":185.2511,\"o\":184.2,\"c\":185.37,\"h\":185.93,\"l\":183.99,\"t\":1719374400000,\"n\":178638},{\"v\":1.2562203e+07,\"vw\":186.6356,\"o\":185.645,\"c\":186.86,\"h\":187.5,\"l\":185.45,\"t\":1719460800000,\"n\":192578},{\"v\":2.1063563e+07,\"vw\":184.4292,\"o\":185.72,\"c\":183.42,\"h\":186.58,\"l\":183.325,\"t\":1719547200000,\"n\":217360},{\"v\":1.154113e+07,\"vw\":184.0893,\"o\":184.48,\"c\":184.49,\"h\":185.34,\"l\":182.73,\"t\":1719806400000,\"n\":173730},{\"v\":1.1740231e+07,\"vw\":185.747,\"o\":183.47,\"c\":186.61,\"h\":186.95,\"l\":183.06,\"t\":1719892800000,\"n\":146339},{\"v\":7.194674e+06,\"vw\":186.9062,\"o\":186.3,\"c\":187.39,\"h\":187.62,\"l\":185.385,\"t\":1719979200000,\"n\":109289},{\"v\":1.3980896e+07,\"vw\":191.3118,\"o\":187.32,\"c\":191.96,\"h\":192.26,\"l\":187.32,\"t\":1720152000000,\"n\":197316},{\"v\":1.1410338e+07,\"vw\":190.4947,\"o\":191.365,\"c\":190.48,\"h\":191.6791,\"l\":189.32,\"t\":1720411200000,\"n\":179236},{\"v\":1.0040905e+07,\"vw\":191.1896,\"o\":191.75,\"c\":190.44,\"h\":192.86,\"l\":190.23,\"t\":1720497600000,\"n\":159389},{\"v\":1.1546966e+07,\"vw\":192.2425,\"o\":190.75,\"c\":192.66,\"h\":193.31,\"l\":190.62,\"t\":1720584000000,\"n\":157695},{\"v\":1.6180016e+07,\"vw\":188.545,\"o\":191.34,\"c\":187.3,\"h\":192.41,\"l\":186.82,\"t\":1720670400000,\"n\":240295},{\"v\":1.40309e+07,\"vw\":187.243,\"o\":186.92,\"c\":186.78,\"h\":188.69,\"l\":186.14,\"t\":1720756800000,\"n\":209312},{\"v\":1.1601542e+07,\"vw\":188.3421,\"o\":186.49,\"c\":188.19,\"h\":189.9,\"l\":186.49,\"t\":1721016000000,\"n\":167112},{\"v\":1.2123381e+07,\"vw\":186.5901,\"o\":188.96,\"c\":185.5,\"h\":190.34,\"l\":185.12,\"t\":1721102400000,\"n\":185505},{\"v\":1.711147e+07,\"vw\":182.8047,\"o\":184.68,\"c\":182.62,\"h\":185.23,\"l\":181.62,\"t\":1721188800000,\"n\":262639},{\"v\":1.7478698e+07,\"vw\":179.9058,\"o\":183.54,\"c\":179.22,\"h\":184.05,\"l\":178.21,\"t\":1721275200000,\"n\":277984},{\"v\":1.3471137e+07,\"vw\":180.0413,\"o\":180.37,\"c\":179.39,\"h\":181.97,\"l\":178.86,\"t\":1721361600000,\"n\":185728},{\"v\":1.497938e+07,\"vw\":183.3689,\"o\":182.35,\"c\":183.35,\"h\":184.3,\"l\":181.9,\"t\":1721620800000,\"n\":210273},{\"v\":2.2763864e+07,\"vw\":184.1738,\"o\":183.84,\"c\":183.6,\"h\":185.22,\"l\":183.33,\"t\":1721707200000,\"n\":288272},{\"v\":3.0521877e+07,\"vw\":175.2361,\"o\":175.39,\"c\":174.37,\"h\":177.95,\"l\":173.57,\"t\":1721793600000,\"n\":469339},{\"v\":2.7966529e+07,\"vw\":171.63,\"o\":174.25,\"c\":169.16,\"h\":175.2,\"l\":169.05,\"t\":1721880000000,\"n\":403278},{\"v\":2.4190234e+07,\"vw\":168.0101,\"o\":168.77,\"c\":168.68,\"h\":169.84,\"l\":165.865,\"t\":1721966400000,\"n\":356413},{\"v\":1.3577105e+07,\"vw\":171.0436,\"o\":170.5,\"c\":171.13,\"h\":172.16,\"l\":169.72,\"t\":1722225600000,\"n\":209090},{\"v\":1.2937117e+07,\"vw\":171.6124,\"o\":171.83,\"c\":171.86,\"h\":172.95,\"l\":170.12,\"t\":1722312000000,\"n\":207748},{\"v\":1.4987386e+07,\"vw\":173.2548,\"o\":174.92,\"c\":173.15,\"h\":175.91,\"l\":171.72,\"t\":1722398400000,\"n\":208334},{\"v\":1.6585762e+07,\"vw\":172.648,\"o\":171.98,\"c\":172.45,\"h\":175.68,\"l\":170.51,\"t\":1722484800000,\"n\":259747},{\"v\":1.8163479e+07,\"vw\":167.8684,\"o\":168.19,\"c\":168.4,\"h\":170.21,\"l\":166.39,\"t\":1722571200000,\"n\":307679},{\"v\":3.4743325e+07,\"vw\":161.8724,\"o\":157.37,\"c\":160.64,\"h\":165.94,\"l\":156.6,\"t\":1722830400000,\"n\":599864},{\"v\":3.5508983e+07,\"vw\":160.6687,\"o\":160.945,\"c\":160.54,\"h\":162.35,\"l\":158.13,\"t\":1722916800000,\"n\":416093},{\"v\":1.8667563e+07,\"vw\":162.0534,\"o\":163.24,\"c\":160.75,\"h\":164.79,\"l\":160.24,\"t\":1723003200000,\"n\":293406},{\"v\":1.4619582e+07,\"vw\":164.1201,\"o\":162.344,\"c\":163.84,\"h\":165.5,\"l\":162.03,\"t\":1723089600000,\"n\":220887},{\"v\":1.3317401e+07,\"vw\":163.103,\"o\":161.645,\"c\":165.39,\"h\":165.52,\"l\":160.93,\"t\":1723176000000,\"n\":216187},{\"v\":1.2087759e+07,\"vw\":164.6036,\"o\":165.995,\"c\":163.95,\"h\":166.7,\"l\":163.55,\"t\":1723435200000,\"n\":174846},{\"v\":1.254602e+07,\"vw\":165.6058,\"o\":165.185,\"c\":165.93,\"h\":166.54,\"l\":164.77,\"t\":1723521600000,\"n\":167174},{\"v\":2.2350864e+07,\"vw\":161.4028,\"o\":164.21,\"c\":162.03,\"h\":164.96,\"l\":159.53,\"t\":1723608000000,\"n\":301587},{\"v\":1.7507334e+07,\"vw\":162.7022,\"o\":162.21,\"c\":163.17,\"h\":163.52,\"l\":161.49,\"t\":1723694400000,\"n\":226855}],\"status\":\"OK\",\"request_id\":\"5c428f8ea392f0c4674c552bd7919980\",\"count\":157}";

        return data;
    }

    @RequestMapping(path = "/historical-stock-quotes2", produces = "application/json;charset=utf-8")
    public List<StockQuote> loadStockDataByCode(@RequestParam(defaultValue = "005930") String code) {

        ArrayList<StockQuote> quotes = new ArrayList<>();
        String pageUrl = "https://finance.naver.com/item/sise_day.naver?code=%s&page=%d";
        for (int i = 1; i < 4; i++) {
            Connection conn = Jsoup.connect(String.format(pageUrl, code, i));
            try {
                Document doc = conn.get();
                // System.out.println(doc.html());

                for (Element e : doc.select("table.type2 tr")) {
                    Elements tds = e.select("td");
                    if (tds.size() == 7) {
                        StockQuote quote = new StockQuote();
                        quote.setDate(tds.get(0).text());
                        quote.setClose(Integer.parseInt(tds.get(1).text().replace(",", "")));
                        String[] v = tds.get(2).text().split(" ");
                        if (v.length == 1) {
                            quote.setIncrease(Integer.parseInt(v[0].replace("보합", "").replace(",", "")));
                        } else {
                            quote.setIncrease(Integer.parseInt(v[1].replace(",", "")));
                            if (v[0].equals("하락")) {
                                quote.setIncrease(quote.getIncrease() * -1);
                            }
                        }
                        quote.setOpen(Integer.parseInt(tds.get(3).text().replace(",", "")));
                        quote.setHigh(Integer.parseInt(tds.get(4).text().replace(",", "")));
                        quote.setLow(Integer.parseInt(tds.get(5).text().replace(",", "")));
                        quote.setVolume(Integer.parseInt(tds.get(6).text().replace(",", "")));

                        quotes.add(quote);
                    }
                }
            } catch(Exception ex) {
                ex.printStackTrace();
            }
            try { Thread.sleep(1000); } catch (Exception ex) {}
        }
        return quotes;
    }


    ///////////////////////////////////////////////////////


    private String get(String apiUrl, String requestMethod, Map<String, String> requestHeaders){

        HttpURLConnection con = connect(apiUrl);
        try {
            con.setRequestMethod(requestMethod);
            if (requestHeaders != null) {
                for (Map.Entry<String, String> header : requestHeaders.entrySet()) {
                    con.setRequestProperty(header.getKey(), header.getValue());
                }
            }

            int responseCode = con.getResponseCode(); // 요청 보내기 + 응답 수신
            if (responseCode == HttpURLConnection.HTTP_OK) { // 정상 호출
                return readBody(con.getInputStream());
            } else { // 오류 발생
                return readBody(con.getErrorStream());
            }
        } catch (IOException e) {
            throw new RuntimeException("Fail to request and response", e);
        } finally {
            con.disconnect();
        }
    }

    private HttpURLConnection connect(String apiUrl){
        try {
            // 웹 요청 수행하는 객체 생성
            URL url = new URL(apiUrl);
            return (HttpURLConnection) url.openConnection();
        } catch (MalformedURLException e) {
            throw new RuntimeException("Invalid API URL format. : " + apiUrl, e);
        } catch (IOException e) {
            throw new RuntimeException("Fail to connect. : " + apiUrl, e);
        }
    }

    private String readBody(InputStream body){
        InputStreamReader streamReader = new InputStreamReader(body, StandardCharsets.UTF_8);

        try (BufferedReader lineReader = new BufferedReader(streamReader)) {
            StringBuilder responseBody = new StringBuilder(1024);

            String line;
            while ((line = lineReader.readLine()) != null) {
                responseBody.append(line);
            }

            return responseBody.toString();
        } catch (IOException e) {
            throw new RuntimeException("Fail to read API response.", e);
        }
    }


}

<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Skolo Online</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts Link For Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    
  </head>
  <body>
    <button class="chatbot-toggler">
      <span class="material-symbols-rounded">mode_comment</span>
      <span class="material-symbols-outlined">close</span>
    </button>
    <div class="chatbot">
      <header>
        <h2>Chatbot</h2>
        <span class="record-btn material-symbols-outlined">mic</span>
      </header>
      <ul class="chatbox">
        <li class="chat incoming">
          <span class="material-symbols-outlined">smart_toy</span>
          <p>Hi there 👋<br>How can I help you today?</p>
        </li>
      </ul>
      <div class="chat-input">
        <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
        <span id="send-btn" class="material-symbols-rounded">send</span>
      </div>
    </div>

    <script src="http://code.jquery.com/jquery-3.7.1.js"></script>
    <script type="text/javascript">
      $(function() {
        const chatbotToggler = $('.chatbot-toggler');

        const closeBtn = $(".close-btn");
        const chatbox = $(".chatbox");
        const chatInput = $(".chat-input textarea");
        const sendChatBtn = $(".chat-input span");

        let userMessage = null;
        let chatHistory = [];

        const inputInitHeight = chatInput.scrollHeight;

        const createChatLi = (message, className) => {
            const chatLi = $("<li></li>");
            chatLi.addClass(["chat", className]);
            let chatContent = className === "outgoing" ? `<p></p>` : `<span class="material-symbols-outlined">smart_toy</span><p></p>`;
            chatLi.html(chatContent);
            chatLi.find("p").text(message);
            return chatLi;
        }

        const generateResponse = (chatElement, message) => {
            const messageElement = chatElement.find("p");

            messageElement.text(message);

            chatbox.scrollTop(chatbox[0].scrollHeight);
        }

        const handleChat = async () => {
          userMessage = chatInput.val().trim();
          if(!userMessage) return;

          // Clear the input textarea and set its height to default
          chatInput.val("");
          chatInput.css('height', `${inputInitHeight}px`);

          // Append the user's message to the chatbox
          chatbox.append(createChatLi(userMessage, "outgoing"));
          chatbox.scrollTop(chatbox[0].scrollHeight);

          chatHistory.push({"role": "user", "content": userMessage});

          try {
              // const response = await fetch('http://localhost:8088/chatbot/chat-text', {  "method": "POST",
              //                                                                             "cache": "no-cache", 
              //                                                                             "headers": { "Content-Type": "application/json;charset=utf-8" },
              //                                                                             "body": JSON.stringify({ "message": userMessage }) });

              // const response = await fetch('http://localhost:8088/chatbot/chat-text-with-history', {  "method": "POST",
              //                                                                             "cache": "no-cache", 
              //                                                                             "headers": { "Content-Type": "application/json;charset=utf-8" },
              //                                                                             "body": JSON.stringify({ "messages": chatHistory }) });

              const response = await fetch('http://localhost:8088/chatbot/search-jobs', { "method": "POST",
                                                                                          "cache": "no-cache", 
                                                                                          "headers": { "Content-Type": "application/json;charset=utf-8" },
                                                                                          "body": JSON.stringify({ "messages": chatHistory }) });                                                                                          

              if (!response.ok) {
                  throw new Error(`HTTP error! status : ${ response.status }`);
              }

              const response_data = await response.json();

              const incomingChatLi = createChatLi("Thinking...", "incoming");
              chatbox.append(incomingChatLi);
              chatbox.scrollTop(chatbox[0].scrollHeight);
              generateResponse(incomingChatLi, response_data.message);

              chatHistory.push({ "role": "assistant", "content": response_data.message})

          } catch (e) {
              console.log(e);
          } finally {
          }
      }

        chatInput.on("input", () => {
            // Adjust the height of the input textarea based on its content
            chatInput.css('height', `${inputInitHeight}px`);
            chatInput.css('height', `${chatInput[0].scrollHeight}px`);
        });

        chatInput.on("keydown", (e) => {
            // If Enter key is pressed without Shift key and the window
            // width is greater than 800px, handle the chat
            if(e.key === "Enter" && !e.shiftKey && window.innerWidth > 800) {
                e.preventDefault();
                handleChat();
            }
        });

        sendChatBtn.on("click", handleChat);

        closeBtn.on("click", () => $('body').removeClass("show-chatbot"));
        chatbotToggler.on('click', (event) => $('body').toggleClass('show-chatbot') );

        ///////////////////////////////////

        const recordBtn = $('.record-btn');

        let mediaRecorder;
        let audioChunks = []; // 오디오 레코딩 실행 중에 부분 데이터를 저장할 배열
        let audioBlob = null;

        recordBtn.on('click', function(event) {

          switch ( $(this).text() ) {
            case "mic":              
              $(this).text('stop_circle');
              navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                  mediaRecorder = new MediaRecorder(stream); // 오디오 기록 도구
                  
                  mediaRecorder.start();
                  console.log('Recording started...');

                  mediaRecorder.ondataavailable = event => {                    
                    audioChunks.push(event.data);
                  };
                })
                .catch(error => {
                  console.error("Error accessing microphone:", error);
                }); 
              break;
            case "stop_circle" :
              $(this).text('mic');
              mediaRecorder.stop();
              mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                audioChunks = []; // Reset the chunks for the next recording

                sendAudioToServer()
              };
              break;
          }

        });

        function sendAudioToServer() {
          const formData = new FormData();
          formData.append('audio', audioBlob, 'recording.wav');

          fetch('http://localhost:8088/chatbot/audio-to-text', {
              method: 'POST',
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              console.log('Server response:', data);
              chatInput.val(data)
          })
          .catch(error => {
              console.error('Error sending audio:', error);
          });
        }

      });
    </script>

  </body>
</html>
